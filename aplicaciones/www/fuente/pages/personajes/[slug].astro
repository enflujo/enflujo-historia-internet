---
import FichaPersonajes from '@/componentes/FichaPersonajes.astro';
import FiltrosHistoriaOral from '@/componentes/FiltrosHistoriaOral.astro';
import NubePalabras from '@/componentes/NubePalabras.astro';
import SeccionEntrevista from '@/componentes/SeccionEntrevista.astro';
import TituloPagina from '@/componentes/TituloPagina.astro';
import Plantilla from '@/plantillas/Plantilla.astro';
import type {
  Categoria,
  EntrevistaPersonaje,
  Personaje,
  EntrevistaWP,
  EntrevistasProcesadas,
  EntrevistaSingularProcesada,
  Termino,
} from '@/tipos';
import {
  convertirTextoAHTML,
  extraerNumeroDesdeTitulo,
  gql,
  pedirDatos,
  procesarAudiosTranscripcion,
} from '@/utilidades/ayudas';
import { opcionesFecha } from '@/utilidades/constantes';

export async function getStaticPaths() {
  const Personajes = gql`
    query {
      personajes(first: 200) {
        nodes {
          title
          slug
        }
      }
    }
  `;
  const { personajes } = await pedirDatos<{ personajes: { nodes: Personaje[] } }>(Personajes);

  return personajes.nodes.map(({ slug }) => {
    return { params: { slug } };
  });
}

const { slug } = Astro.params;

const PeticionEntrevistaCompleta = gql`
  query {
    personaje(id: "${slug}", idType: SLUG) {
      title
      slug
      content(format: RENDERED)
      featuredImage {
        node {
          altText
          sourceUrl
        }
      }

      entrevistas {
        nodes {
          fecha
          ordenTranscripciones
          transcripciones(first: 200) {
            nodes {
              title
              transcripcion(format: RAW)
              databaseId
              categories {
                nodes {
                  slug
                  name
                  count
                  children {
                    nodes {
                      slug
                      name
                      count
                    }
                  }
                }
              }
              audios(first: 200) {
                nodes {
                  archivos {
                    node {
                      filePath
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
`;

const entrevista = await pedirDatos<EntrevistaPersonaje>(PeticionEntrevistaCompleta);
const terminosPersonaje: Termino[] = [];
const entrevistaProcesada = procesarEntrevistasPersonaje(entrevista.personaje.entrevistas.nodes);

function procesarEntrevistasPersonaje(entrevistas: EntrevistaWP[]): EntrevistasProcesadas {
  const categoriasPersonaje: Categoria[] = [];
  const entrevistasPersonaje: EntrevistaSingularProcesada[] = [];

  entrevistas.forEach((entrevista) => {
    const { fecha, transcripciones, ordenTranscripciones } = entrevista;
    const fechaEntrevista = new Date(fecha);
    let entrevistaActual = entrevistasPersonaje.find((entrevista) => entrevista.fecha === fechaEntrevista);

    if (!entrevistaActual) {
      entrevistaActual = {
        fecha: fechaEntrevista,
        secciones: [],
      };
      entrevistasPersonaje.push(entrevistaActual);
    }

    transcripciones.nodes.sort((a, b) => {
      return ordenTranscripciones.indexOf(a.databaseId) - ordenTranscripciones.indexOf(b.databaseId);
    });

    transcripciones.nodes.forEach((transcripcion) => {
      const { transcripcion: textoTranscripcion, audios } = transcripcion;

      const audiosTranscripcion = procesarAudiosTranscripcion(audios);
      const textoProcesado = convertirTextoAHTML(textoTranscripcion, terminosPersonaje);
      // terminosPersonaje.push(...textoProcesado.terminos);

      entrevistaActual.secciones.push({
        contenido: textoProcesado.texto,
        audios: audiosTranscripcion,
        categorias: transcripcion.categories.nodes.map((categoria) => {
          return {
            nombre: categoria.name,
            slug: categoria.slug,
            conteo: categoria.count,
            hijos: categoria.children.nodes.map((hijo) => {
              return {
                nombre: hijo.name,
                slug: hijo.slug,
                conteo: hijo.count,
              };
            }),
          };
        }),
      });

      transcripcion.categories.nodes.forEach((categoria) => {
        if (categoria.slug === 'sin-categoria') return;

        const { slug, name, children } = categoria;
        let existe = categoriasPersonaje.find((cat) => cat.slug === slug);

        if (!existe) {
          existe = {
            nombre: name,
            slug,
            conteo: 1,
            hijos: [],
          };
          categoriasPersonaje.push(existe);
        } else {
          existe.conteo++;
        }

        if (children.nodes.length > 0) {
          children.nodes.forEach((hijo) => {
            if (hijo.slug === 'sin-categoria') return;
            const existeHijo = existe.hijos.find((cat) => cat.slug === hijo.slug);

            if (!existeHijo) {
              existe.hijos.push({
                nombre: hijo.name,
                slug: hijo.slug,
                conteo: 1,
              });
            } else {
              existeHijo.conteo++;
            }
          });
        }
      });
    });
  });

  categoriasPersonaje.sort((a, b) => b.conteo - a.conteo);
  categoriasPersonaje.forEach((categoria) => {
    categoria.hijos.sort((a, b) => b.conteo - a.conteo);
  });

  return { categoriasPersonaje, entrevistas: entrevistasPersonaje };
}

//POR HACER: cambiar descripcion por bio procesada del personaje
---

<Plantilla titulo={entrevista.personaje.title} descripcion={'entrevista.personaje'}>
  <div class="paginaConMenuIzquierdo">
    <aside class="menuIzquierdo">
      <TituloPagina titulo="Historia Oral" slug="historia-oral" modo="oscuro" />
      <FiltrosHistoriaOral />
    </aside>

    <main class="historia-oral">
      <div class="col2">
        <FichaPersonajes
          nombre={entrevista.personaje.title}
          slug={entrevista.personaje.slug}
          bio={entrevista.personaje.content}
          foto={entrevista.personaje.featuredImage}
          categorias={entrevistaProcesada.categoriasPersonaje}
        />

        <NubePalabras terminos={terminosPersonaje} />

        <div id="contenedorEntrevistas">
          {
            entrevistaProcesada.entrevistas.map((entrevista) => (
              <section class="entrevista">
                <h3>Entrevista: {entrevista.fecha.toLocaleDateString('es-CO', opcionesFecha)}</h3>
                {entrevista.secciones.map((seccion) => (
                  <SeccionEntrevista seccion={seccion} />
                ))}
              </section>
            ))
          }
        </div>
      </div>
    </main>
  </div>
</Plantilla>
