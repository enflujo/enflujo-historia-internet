---
import FiltrosHistoriaOral from '@/componentes/FiltrosHistoriaOral.astro';
import NubePalabras from '@/componentes/NubePalabras.astro';
import SeccionEntrevista from '@/componentes/SeccionEntrevista.astro';
import TituloPagina from '@/componentes/TituloPagina.astro';
import FiltroFoto from '@/componentes/FiltroFoto.astro';
import Plantilla from '@/plantillas/Plantilla.astro';
import type { SeccionEntrevistaProcesadaCruzada, Imagen, Termino } from '@/tipos';
import { base } from '@/utilidades/constantes';

const categoria = 'Categoría';
export async function getStaticPaths() {
  const { obtenerCategorias } = await import('@/utilidades/cache');
  const categorias = obtenerCategorias();
  return categorias.map(({ slug, name }) => ({ params: { slug }, props: { nombreCategoria: name } }));
}

const { slug } = Astro.params;
const { nombreCategoria } = Astro.props;
const { obtenerTranscripcionesCategoria } = await import('@/utilidades/cache');
const transcripciones = obtenerTranscripcionesCategoria(slug);
const terminosCategoria: Termino[] = [];
const personajesCategoria: { nombre: string; slug: string; imagen: Imagen | null }[] = [];

const transcripcionesProcesadas: SeccionEntrevistaProcesadaCruzada[] = transcripciones.map((transcripcion) => {
  const { transcripcionHTML, terminos, audios, categorias, entrevista } = transcripcion as any;

  // Agregar términos de esta transcripción a la lista general
  if (terminos && terminos.length > 0) {
    terminos.forEach((t: Termino) => {
      const existe = terminosCategoria.find((term) => term.slug === t.slug);
      if (existe) {
        existe.conteo += t.conteo;
      } else {
        terminosCategoria.push(t);
      }
    });
  }

  return {
    contenido: transcripcionHTML || '',
    audios: audios || [],
    categorias: categorias || [],
    personajes: entrevista.node.personajes.nodes.map((personaje: any) => {
      // Guardar los personajes que aparecen en esta categoría
      const existe = personajesCategoria.find((p) => p.slug === personaje.slug);
      if (!existe) {
        personajesCategoria.push({
          nombre: personaje.title,
          slug: personaje.slug,
          imagen: personaje.featuredImage
            ? {
                node: {
                  altText: personaje.featuredImage.node.altText,
                  sourceUrl: personaje.featuredImage.node.sourceUrl,
                },
              }
            : null,
        });
      }

      return {
        nombre: personaje.title,
        slug: personaje.slug,
      };
    }),

    fechaEntrevista: new Date(entrevista.node.fecha),
  };
});
---

<Plantilla titulo={nombreCategoria} descripcion={categoria} conMenuIzquierdo={true}>
  <div class="paginaConMenuIzquierdo">
    <aside class="menuIzquierdo">
      <TituloPagina titulo="Historia Oral" slug={slug} modo="oscuro" />
      <FiltrosHistoriaOral />
    </aside>

    <main class="col2" data-pagefind-body data-pagefind-meta="seccion:Historia Oral">
      <h1 class="tituloCategoria" data-pagefind-meta="title">{nombreCategoria}</h1>

      <section id="resumenPersonajes">
        <div class="cajaPersonajes">
          {
            personajesCategoria.map((personaje) => {
              const { nombre, slug, imagen } = personaje;
              return (
                <a class="personaje" href={`${base}/personajes/${slug}`}>
                  {imagen && <FiltroFoto ruta={imagen.node.sourceUrl} alt={imagen.node.altText} />}
                  <p class="nombrePersonaje">{nombre}</p>
                </a>
              );
            })
          }
        </div>

        <NubePalabras terminos={terminosCategoria} />

        <div class="transcripciones">
          {
            transcripcionesProcesadas.map((transcripcion) => {
              const { personajes } = transcripcion;

              return (
                <div class="transcripcion">
                  <div class="personajes">
                    {personajes.map((personaje) => {
                      const { nombre, slug } = personaje;
                      return (
                        <div class="personaje">
                          <h2 class="nombrePersonaje">
                            <a href={`${base}/personajes/${slug}`}>{nombre}</a>
                          </h2>
                          <p class="fecha">
                            {transcripcion.fechaEntrevista.toLocaleDateString('es-ES', {
                              year: 'numeric',
                              month: 'long',
                              day: 'numeric',
                            })}
                          </p>
                        </div>
                      );
                    })}
                  </div>
                  <SeccionEntrevista seccion={transcripcion} />
                </div>
              );
            })
          }
        </div>
      </section>
    </main>
  </div>
</Plantilla>

<style lang="scss">
  .tituloCategoria {
    text-align: center;
    font-size: 2.5em;
    font-family: var(--fuenteTitulos);
  }

  .paginaCategorias {
    display: flex;
  }

  .contenido {
    padding: 1em 2em 5em 2em;
  }

  #resumenPersonajes {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .cajaPersonajes {
    display: flex;
    flex-wrap: wrap;
    gap: 1em;
    margin-bottom: 2em;

    .personaje {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  }

  .nombrePersonaje {
    margin: 0.3em 0 4px 0;
  }

  .fecha {
    font-size: 0.8em;
    font-style: italic;
    margin-top: 0;
  }
</style>
