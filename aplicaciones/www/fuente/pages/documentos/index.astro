---
import type { Pagina, Documento, MetaInfo } from '@/tipos';
import TituloPagina from '@/componentes/TituloPagina.astro';
import FiltrosDocumentos from '@/componentes/FiltrosDocumentos.astro';
import { esquemaPagina, gql, pedirDatos, procesarCategorias } from '@/utilidades/ayudas';
import Plantilla from '@/plantillas/Plantilla.astro';
import { apiBase, base } from '@/utilidades/constantes';
import { listaCategoriasPrincipales } from '@/cerebros/general';

const PeticionPagina = gql`
  query {
    ${esquemaPagina('documentos')}
  }
`;

async function pedirSeccionDatos(cursorDocumentos: string = '', documentosProcesados: Documento[] = []) {
  const EsquemaDocumentos = gql`
    query Documentos {
      documentos(first: 1000${cursorDocumentos ? `, after: "${cursorDocumentos}"` : ''}) {
        pageInfo {
          hasNextPage
          hasNextPage
          hasPreviousPage
          startCursor
          endCursor
        }
        
        nodes {
          id
          status
          slug
          title
          tituloCorto
          descripcion
          fecha
          autores
          fuente(format: RAW)
          identificador
          archivos {
            nodes {
              filePath
            }
          }
          tiposDeDocumentos {
            nodes {
              slug
              name
            }
          }
          featuredImage {
            node {
              filePath
            }
          }
          categories {
            edges {
              node {
                name
                slug
                parent {
                  node {
                    slug
                    name
                  }
                }
              }
            }
          }
        }
      }
    }
  `;

  const { documentos: algunosDocumentos } = await pedirDatos<{
    documentos: { pageInfo: MetaInfo; nodes: Documento[] };
  }>(EsquemaDocumentos);
  documentosProcesados.push(...algunosDocumentos.nodes.filter((documento) => documento.status === 'publish'));

  if (algunosDocumentos.pageInfo.hasNextPage) {
    return await pedirSeccionDatos(algunosDocumentos.pageInfo.endCursor, documentosProcesados);
  }

  return documentosProcesados;
}

const { pagina, documentos } = await pedirDatos<{ page: Pagina }>(PeticionPagina).then(async (respuesta) => ({
  pagina: respuesta.page,
  documentos: await pedirSeccionDatos(),
}));

documentos.forEach((documento) => {
  const categorias = procesarCategorias(documento.categories);
  documento.categorias = categorias;
});

// Extraer todas las categorías únicas de todos los documentos
const mapaCategorias = new Map<string, { slug: string; nombre: string; conteo: number }>();
const mapaTipos = new Map<string, { slug: string; nombre: string; conteo: number }>();

documentos.forEach((documento) => {
  if (documento.categorias) {
    documento.categorias.forEach((categoria) => {
      const existe = mapaCategorias.get(categoria.slug);
      if (existe) {
        existe.conteo++;
      } else {
        mapaCategorias.set(categoria.slug, {
          slug: categoria.slug,
          nombre: categoria.nombre,
          conteo: 1,
        });
      }
    });
  }

  if (documento.tiposDeDocumentos?.nodes) {
    documento.tiposDeDocumentos.nodes.forEach((tipo) => {
      const existe = mapaTipos.get(tipo.slug);
      if (existe) {
        existe.conteo++;
      } else {
        mapaTipos.set(tipo.slug, {
          slug: tipo.slug,
          nombre: tipo.name,
          conteo: 1,
        });
      }
    });
  }
});

const categoriasDisponibles = Array.from(mapaCategorias.values()).sort((a, b) => a.nombre.localeCompare(b.nombre));
const tiposDisponibles = Array.from(mapaTipos.values()).sort((a, b) => a.nombre.localeCompare(b.nombre));
const categoriasPrincipales = await listaCategoriasPrincipales();
---

<Plantilla titulo={pagina.title} descripcion={pagina.descripcion}>
  <div class="paginaConMenuIzquierdo">
    <aside class="menuIzquierdo">
      <TituloPagina titulo={pagina.title} slug={pagina.slug} modo="oscuro" />
      <FiltrosDocumentos categorias={categoriasDisponibles} tipos={tiposDisponibles} />
    </aside>

    <main class="documentos col2">
      <div class="contenedorResultados">
        <p class="conteoResultados">
          Mostrando <span id="conteoActual">{documentos.length}</span> de <span id="conteoTotal"
            >{documentos.length}</span
          > documentos
        </p>
      </div>

      <div class="contenedorDocumentos">
        {
          documentos.map((documento) => (
            <article
              class="documento"
              data-categorias={JSON.stringify(documento.categorias?.map((c) => c.slug) || [])}
              data-tipos={JSON.stringify(documento.tiposDeDocumentos?.nodes?.map((t) => t.slug) || [])}
            >
              <h2 class="nombreDocumento">
                <a href={`${base}/documentos/${documento.slug}`}>{documento.tituloCorto}</a>
              </h2>

              {documento.featuredImage && documento.featuredImage.node && documento.featuredImage.node.filePath && (
                <div class="imagenDestacada">
                  <a href={`${base}/documentos/${documento.slug}`}>
                    <img
                      src={`${apiBase}/${documento.featuredImage.node.filePath}`}
                      alt={`Imagen para ${documento.title}`}
                    />
                  </a>
                </div>
              )}

              {documento.categorias && documento.categorias.length > 0 && (
                <div class="categorias">
                  {documento.categorias.map((categoria) => (
                    <span
                      class={`categoriaEnDocumento iconoCategoria iconoCategoria${categoriasPrincipales.findIndex((cat) => cat.slug === categoria.slug) + 1}`}
                    >
                      {categoria.nombre}
                    </span>
                  ))}
                </div>
              )}
            </article>
          ))
        }
      </div>
    </main>
  </div>
</Plantilla>

<script>
  // Lógica de filtrado de documentos por categorías y tipos
  function inicializarFiltros() {
    const checkboxesCategorias = document.querySelectorAll<HTMLInputElement>('.checkboxCategoria');
    const checkboxesTipos = document.querySelectorAll<HTMLInputElement>('.checkboxTipo');
    const documentos = document.querySelectorAll<HTMLElement>('.documento');
    const botonLimpiar = document.querySelector<HTMLButtonElement>('.botonLimpiar');
    const conteoActual = document.getElementById('conteoActual');
    const conteoTotal = document.getElementById('conteoTotal');
    const totalDocumentos = documentos.length;

    function aplicarFiltros() {
      // Obtener categorías y tipos seleccionados
      const categoriasSeleccionadas = Array.from(checkboxesCategorias)
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => checkbox.value);

      const tiposSeleccionados = Array.from(checkboxesTipos)
        .filter((checkbox) => checkbox.checked)
        .map((checkbox) => checkbox.value);

      let conteoVisible = 0;

      documentos.forEach((documento) => {
        const categoriasDocumento = JSON.parse(documento.dataset.categorias || '[]');
        const tiposDocumento = JSON.parse(documento.dataset.tipos || '[]');

        // Si no hay filtros seleccionados, mostrar todos
        if (categoriasSeleccionadas.length === 0 && tiposSeleccionados.length === 0) {
          documento.style.display = '';
          conteoVisible++;
        } else {
          // Verificar si cumple con los filtros de categoría (si hay alguno seleccionado)
          const cumpleCategoria =
            categoriasSeleccionadas.length === 0 ||
            categoriasSeleccionadas.some((cat) => categoriasDocumento.includes(cat));

          // Verificar si cumple con los filtros de tipo (si hay alguno seleccionado)
          const cumpleTipo =
            tiposSeleccionados.length === 0 || tiposSeleccionados.some((tipo) => tiposDocumento.includes(tipo));

          // Mostrar solo si cumple ambos filtros
          const mostrar = cumpleCategoria && cumpleTipo;

          documento.style.display = mostrar ? '' : 'none';
          if (mostrar) conteoVisible++;
        }
      });

      // Actualizar conteo
      if (conteoActual) {
        conteoActual.textContent = conteoVisible.toString();
      }

      // Habilitar/deshabilitar botón de limpiar
      if (botonLimpiar) {
        botonLimpiar.disabled = categoriasSeleccionadas.length === 0 && tiposSeleccionados.length === 0;
      }
    }

    // Escuchar cambios en los checkboxes de categorías y tipos
    checkboxesCategorias.forEach((checkbox) => {
      checkbox.addEventListener('change', aplicarFiltros);
    });

    checkboxesTipos.forEach((checkbox) => {
      checkbox.addEventListener('change', aplicarFiltros);
    });

    // Limpiar filtros
    if (botonLimpiar) {
      botonLimpiar.addEventListener('click', () => {
        checkboxesCategorias.forEach((checkbox) => {
          checkbox.checked = false;
        });
        checkboxesTipos.forEach((checkbox) => {
          checkbox.checked = false;
        });
        aplicarFiltros();
      });
    }

    // Inicializar el conteo total
    if (conteoTotal) {
      conteoTotal.textContent = totalDocumentos.toString();
    }

    // Estado inicial del botón
    if (botonLimpiar) {
      botonLimpiar.disabled = true;
    }
  }

  // Ejecutar cuando el DOM esté listo
  document.addEventListener('DOMContentLoaded', inicializarFiltros);
</script>

<style lang="scss">
  .nombreDocumento {
    font-size: 1.2em;
  }

  .contenedorResultados {
    padding: 1rem 2rem;
    margin-bottom: 1rem;

    .conteoResultados {
      font-size: 1rem;
      color: var(--colorTexto);
      opacity: 0.8;
      margin: 0;

      #conteoActual {
        font-weight: bold;
        color: var(--cobalto);
      }
    }
  }

  .contenedorDocumentos {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
    gap: 2rem;
    padding: 2rem;
  }

  .documento {
    padding: 1.5rem;
    background-color: var(--superficieClaro);
    transition: transform 0.2s ease-in-out;

    h2 {
      margin-top: 0;
      color: var(--colorTexto);
      font-family: var(--fuenteTitulos);
    }
  }

  .metadatos {
    font-size: 0.9rem;
    color: var(--colorTexto);
    opacity: 0.8;
    margin-bottom: 1rem;

    p {
      margin: 0.3rem 0;
    }
  }

  .archivos {
    margin-top: 1.5rem;

    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      margin-bottom: 0.5rem;
    }

    a {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: var(--cobalto);
      text-decoration: none;
      max-width: 100%;
      word-wrap: break-word;

      &:hover {
        background-color: var(--rojo);
      }
    }
  }

  .subtitulo {
    display: block;
  }

  .categoria {
    font-weight: 600;
  }

  .hijos {
    font-size: 0.9em;
    margin-bottom: 0.5em;
  }

  .imagenDestacada {
    margin: 1.5rem 0;
    padding: 4px;
    overflow: hidden;

    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
  }

  .categorias {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .categoriaEnDocumento {
    display: inline-block;
    font-size: 0.75rem;
  }
</style>
