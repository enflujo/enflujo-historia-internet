---
import FiltrosHistoriaOral from '@/componentes/FiltrosHistoriaOral.astro';
import TituloPagina from '@/componentes/TituloPagina.astro';
import FichaPersonajes from '@/componentes/FichaPersonajes.astro';
import RedRelaciones from '@/componentes/RedRelaciones.astro';
import Plantilla from '@/plantillas/Plantilla.astro';
import { obtenerPagina, obtenerPersonajes } from '@/utilidades/cache';
import { tieneContenidoHTML } from '@/utilidades/ayudas';

const pagina = await obtenerPagina('historia-oral');
if (!pagina) {
  throw new Error('Página historia-oral no encontrada');
}

const personajes = await obtenerPersonajes();

personajes.sort((a, b) => {
  const nombreA = a.title.toLowerCase();
  const nombreB = b.title.toLowerCase();

  if (nombreA < nombreB) return -1;
  if (nombreA > nombreB) return 1;
  return 0;
});
// const terminosGlobales = await listaTerminos();
---

<Plantilla titulo={pagina.title} descripcion={pagina.descripcion} conMenuIzquierdo={true}>
  <div class="paginaConMenuIzquierdo">
    <button class="btnToggleFiltros" id="btnToggleFiltros" aria-controls="menuFiltros"> ☰ Filtros </button>
    <div class="filtrosOverlay" id="filtrosOverlay"></div>

    <aside class="menuIzquierdo" id="menuFiltros">
      <TituloPagina titulo={pagina.title} slug={pagina.slug} modo="oscuro" />
      <FiltrosHistoriaOral />
    </aside>

    <main class="col2" data-pagefind-body>
      <div class="personajes">
        <h2 class="subtituloPagina">Personajes</h2>
        {tieneContenidoHTML(pagina.content) && <div class="introPagina" set:html={pagina.content} />}
        <div class="visMedia"><RedRelaciones /></div>
        <div class="personajes-lista">
          {
            personajes.map((personaje) => (
              <FichaPersonajes
                slug={personaje.slug}
                nombre={personaje.title}
                bio={personaje.content}
                foto={personaje.featuredImage}
                categorias={[]}
                enlace={true}
              />
            ))
          }
        </div>
      </div>
    </main>
  </div>

  <style lang="scss">
    .personajes {
      width: 100%;

      h2 {
        margin-bottom: 1.5rem;
        font-family: var(--fuenteTitulos);
        color: var(--colorTexto);
      }
    }

    .personajes-lista {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
      width: 100%;
      margin: 0 auto;
    }

    @media (max-width: 1100px) {
      .personajes-lista {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 700px) {
      .personajes-lista {
        gap: 1rem;
      }
    }
  </style>

  <script>
    const btnToggle = document.getElementById('btnToggleFiltros');
    const menu = document.getElementById('menuFiltros');
    const overlay = document.getElementById('filtrosOverlay');

    if (btnToggle && menu && overlay) {
      btnToggle.addEventListener('click', () => {
        menu.classList.toggle('abierto');
        overlay.classList.toggle('visible');
      });

      overlay.addEventListener('click', () => {
        menu.classList.remove('abierto');
        overlay.classList.remove('visible');
      });
    }
  </script>
</Plantilla>
